<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../asq-base/asq-base.html">

<link rel="import" href="elements/asq-buckets-q-viewer.html">
<link rel="import" href="elements/asq-buckets-q-presenter.html">

<!--
`asq-buckets-q` is a kind of matching question. To use this question, you need to difine two sets, `X` set and `Y` set, using `x-matchable` and `y-matchable`.

Users can make matches between `X` and `Y` set. The matches can be either `1-m` and `1-1` relation, by specifing `mode` attribute.


Examples:
    
    <asq-buckets-q 
      mode="1-2" 
      x-matchable="div[bucket]" 
      y-matchable="div[label]" 
      attr-for-matched="s-name"
      matched-attribute="matched"
      label-container="[labels]"
      matched-class="label-success">

      <div buckets>
        <div s-name="china" bucket><b>china</b></div>
        <div s-name="france" bucket><b>france</b></div>
        <div s-name="kroea" bucket><b>kroea</b></div>
      </div>
      
      <div labels>
        <div s-name="sun" label class="label-primary">sun</div>
        <div s-name="moon" label class="label-primary">moon</div>
        <div s-name="sky" label class="label-primary">sky</div>
        <div s-name="mar" label class="label-primary">mar</div>
        <div s-name="info" label class="label-primary">info</div>
        <div s-name="2000" label class="label-primary">2000</div>
      </div>
    </asq-buckets-q>



@element asq-asq-buckets-q
@demo demo/index.html
@group ASQ Elements
@blurb ASQ buckets questions.
@homepage http://github.com/ASQ-USI-Elements/asq-buckets-q
-->
<dom-module id="asq-buckets-q">
  
  <style is="custom-style">
    :host {
      display: block;
    }
  </style>

  <template>
    <template is="dom-if" if="{{hasRole(role, roles.VIEWER)}}" restamp>
      <asq-buckets-q-viewer
        role="viewer" 
        uid="[[uid]]"
        mode="{{mode}}" 
        x-matchable="{{xMatchable}}" 
        y-matchable="{{yMatchable}}" 
        attr-for-matched="{{attrForMatched}}"
        matched-attribute="{{matchedAttribute}}"
        matched-class="{{matchedClass}}"
        label-container="{{labelContainer}}"
        on-dragging-class="{{onDraggingClass}}"
        event-bus="[[eventBus]]">
        <content></content>
      </asq-buckets-q-viewer>
    </template>

    <template is="dom-if" if="{{hasRole(role, roles.PRESENTER)}}" restamp>
      <asq-buckets-q-presenter
        role="presenter" 
        uid="[[uid]]"
        mode="{{mode}}" 
        x-matchable="{{xMatchable}}" 
        y-matchable="{{yMatchable}}" 
        attr-for-matched="{{attrForMatched}}"
        matched-attribute="{{matchedAttribute}}"
        matched-class="{{matchedClass}}"
        label-container="{{labelContainer}}"
        on-dragging-class="{{onDraggingClass}}"
        event-bus="[[eventBus]]">
        <content></content>
      </asq-buckets-q-presenter>
    </template>
    
  </template>

  <script>
    Polymer({
      is: 'asq-buckets-q',

      behaviors: [
        ASQ.asqQuestionElementBehavior
      ],


      properties: {
        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          notify: true
        }
      },

      api: undefined,

      created: function () {
        document.addEventListener('asq-ready', function (evt) {
          this.eventBus = evt.detail.asqEventBus
        }.bind(this));

        this.listen(this, 'role-changed', '_onRoleChanged');
      },

      attached: function() {
        this.async(function() {
          this._setApi();
        })
      },

      _onRoleChanged: function() {
        this._setApi();
      },

      _setApi: function() {
        var selector = 'asq-buckets-q-' + this.role;
        this.api = this.$$(selector);
      },

      submit: function () {
        if (this.role == this.roles.VIEWER) {
          var el = this.$$('asq-buckets-q-viewer');
          if (!el) {
            throw new Error('submit(): expected asq-css-select-q-viewer element to exist');
          }
          return el.submit();
        }
      }

    });
  </script>

</dom-module>